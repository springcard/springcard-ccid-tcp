<!DOCTYPE html>
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="http://tech.springcard.com/xmlrpc.php">
<title>Networked PC/SC under Unix/Linux with PCSC-Lite | SpringCard TechZone</title>
<link rel="alternate" type="application/rss+xml" title="SpringCard TechZone » Feed" href="http://tech.springcard.com/feed/">
<link rel="alternate" type="application/rss+xml" title="SpringCard TechZone » Comments Feed" href="http://tech.springcard.com/comments/feed/">
</head>
<body>        
	<div>		
		<article>
			<header>
				<img src="img/logo.png">
				<h1>Networked PC/SC under Unix/Linux with PCSC-Lite and Springcard's FunkyGate IP PCSC</h1>
			</header>

			<div>
				<p>Products in the SpringCard <font color='red'>FunkyGate-IP-PCSC Family</font></p>
				<p>This makes those products usable on non-Windows operating systems thanks to PCSC-Lite CCID driver.</p>
				
				<h1>Introduction</h1>
				<h2>PC/SC standard</h2>
				<p>
					<a title="The PC/SC Workgroup" href="http://www.pcscworkgroup.com/">PC/SC is the de-facto standard</a> to interface Personal Computers with Smart Cards (and smartcard readers of course). Even if PC/SC has been initialy promoted by Microsoft -and has been implemented for long in Windows-, the standard is not limited to MS’ operating systems.
				</p>
				<p>
				<a title="PC/SC Lite main page" href="http://pcsclite.alioth.debian.org/">PCSC-Lite is an open source implementation of PC/SC</a>, part of a global project named <a title="MUSCLE project page" href="http://www.musclecard.com/">MUSCLE</a> (Movement for the Use of Smart Cards in a Linux Environment). Despite its name, the <span class="explanatory-dictionary-highlight" data-definition="explanatory-dictionary-definition-21" data-hasqtip="6">PC/SC stack offered by MUSCLE is not limited to GNU/Linux anymore. Their compatibility list now includes other popular UNIXes, including Apple Mac OS X and Solaris.
				</p>
				
				<h2>CCID standard</h2>
				<p>
					The <a title="USB CCID Specification (PDF)" href="http://www.usb.org/developers/devclass_docs/DWG_Smart-Card_CCID_Rev110.pdf">USB CCID specification</a> published by the <a title="USB Workgroup" href="http://www.usb.org/">USB Workgroup</a> aims to normalize USB smartcard readers, in order to have a single driver (supplied once for all with the operating system) for virtually any reader from any manufacturer.
				</p>
				<p>
					PCSC-Lite project includes an <a title="PC/SC Lite CCID driver project page" href="http://pcsclite.alioth.debian.org/ccid.html">open source CCID driver</a>. This driver has been tested with SpringCard <a title="CSB6" href="http://www.springcard.com/en/products/csb6.html" target="_blank">CSB6</a> on GNU/Linux, and should work on the other operating systems targetted by the project.
				</p>
				<p> The new <strong>"PCSC over Network Driver"</strong> library by Springcard bring access to compliant networked readers to the open source CCID driver.</p>
				
				<h2>Disclaimer and warning</h2>
				<p>
					There’s no relationship between SpringCard and the developers involved in the open source PCSC-Lite project.
				</p>
				<p>
					Apart from this explanation page, SpringCard can’t provide any technical support related to PCSC-Lite middleware nor PCSC-Lite CCID driver.
				</p>
				
				<h2>FunkyGate-IP-PCSC Family on GNU/Linux</h2>
				<p>
					In this part we’re going to install PCSC-Lite and <a title="FunkyGate-IP-PCSC" href="http://www.springcard.com/en/products/" target="_blank">FunkyGate-IP-PCSC</a>‘s drivers on Ubuntu 10.04 LTS and Raspbian 7.8. Some parts of the procedure may vary a little, depending on the GNU/Linux distribution you’re working with.
				</p>
				<p>
					<em>You must download and install the driver before connecting the product.</em>
				</p>
				
				<h2>Download</h2>
				<p>
					You most download the required package : <a href="http://pcsclite.alioth.debian.org/">pcsclite.alioth.debian.org</a> or <a href="http://ludovic.rousseau.free.fr/softwares/">ludovic.rousseau.free.fr/softwares/</a> to download <strong>PCSC-Lite, CCID Driver, PCSC-Tools and PCSC-perl</strong> :
				</p>
				<p>
					PCSC-Lite : file named <code>pcsc-lite-x.y.z.tar.bz2</code>, “x.y.z” being the version number,<br>
					CCID driver : file named <code>ccid-x.y.z.tar.bz2</code>, “x.y.z” being the version number,<br>
					PCSC Tools : file named <code>pcsc-tools-x.y.z.tar.bz2</code>, “x.y.z” being the version number,<br>
					PCSC Perl : file named <code>pcsc-perl-x.y.z.tar.bz2</code>, “x.y.z” being the version number.
				</p>
				<p>
					You will need to download Springcard's PCSC over Network Driver available<font color='red'> ....somewhere.... </font>
				</p>
				
				<h1>Installation</h1>
				<p>
					Connect as <code>root</code>.
				</p>
				<p>
					Download the required packages:
				</p>
				<code>
					wget https://alioth.debian.org/frs/download.php/file/4126/pcsc-lite-1.8.13.tar.bz2<br/>
					wget https://alioth.debian.org/frs/download.php/file/4111/ccid-1.4.18.tar.bz2<br/>
					wget http://ludovic.rousseau.free.fr/softwares/pcsc-perl/pcsc-perl-1.4.13.tar.bz2<br/>
					wget http://ludovic.rousseau.free.fr/softwares/pcsc-tools/pcsc-tools-1.4.23.tar.gz<br/>
					<font color='red'>wget http://files.springcard.com/springcard_ccid_tcp.taz.gz</font>
				</code>

				<p>
					Uncompress all archives.
				</p>
				<code>					
					tar xjf pcsc-lite-1.8.13.tar</br>
					tar xjf ccid-1.4.18.tar</br>
					tar xjf pcsc-perl-1.4.13.tar</br>
					tar xjf pcsc-tools-1.4.23.tar</br>
					tar xvfz springcard_ccid_tcp.tar.gz</br>
				</code>
				<br/>
				<img src="img/sprpcsc1.png">
				<p>
					<em>N.B. : On Ubuntu (and on some other Linuxes), connecting as root is not possible. In this case, one must prefix every command by “sudo”, to gain root’s priviledges temporary.</em>
				</p>
				
				<h2>Prepare the builds</h2>
				<p>
					Warning, on some Linux distributions, like Raspbian for example, the system comes with a pre installed lib but in an old version of pcsc-lite (for example an 1.8.3 or 1.8.5 version).
				</p>
				<p>
					First uninstall all previous version of the above package before building and setting up the new ones.
				</p>
				<p>
					Before to install pcsc-lite you should also verify that libusb is up to date and if necessary install the <em>dev</em> version :
				</p>
				<code>
					apt-get install libudev-dev  libusb-1.0-0-dev libusb-dev
				</code>
				</br></br>
				<strong>In this documentation, all package will be setup in a specific directory (using the --prefix option) but you could build everything without this option.</strong>
				
				<h2>Installing PCSC-Lite</h2>
				<p>
					Open a terminal and go to the directory where you have uncompressed PCSC-Lite.<br>
					Enter the commands :
				</p>
				<p>
					<code>
						cd pcsc-lite-1.8.13/<br/>
						./configure --prefix=/opt/pcsc<br/>
						make<br>
						make install
					</code>
				</p>
				Troubleshooting
				<p>
					If the configure step fails with message <code>error: usb.h not found</code>, check that you have the <a href="http://libusb.sourceforge.net/">libusb library</a> installed. If needed, please install it, and then give the path to this library to the configuration script: <code>./configure LIBUSB_CFLAGS=...</code>.
				</p>
				<p>
					On Ubuntu or Debian, you may alternatively use <code>apt-get</code> to download and install the <code>libusb-dev</code> package :<br>
					<code>apt-get install libusb-dev</code>
				</p>
				<p>
					Update library path - make use of our new library:<br/>
					<code>
						rm /usr/lib/arm-linux-gnueabihf/libpcsclite.so.1 (only on Raspbian)<br />
						rm /lib/libpcsclite.so.1<br />
						ln -s /opt/pcsc/lib/libpcsclite.so.1.0.0 /lib/libpcsclite.so.1
					</code>
				</p>

				<h2>Installing CCID driver</h2>
				<p>
					Open a terminal and go to the directory where you have uncompressed the CCID Driver archive. Enter the commands :
				</p>
				<p>
					<code>
						cd ../ccid-1.4.18/<br/>
						./configure --prefix=/opt/pcsc PKG_CONFIG_PATH=/opt/pcsc/lib/pkgconfig/<br>
						make<br>
						make install
					</code>
				</p>

				<h2>Installing PCSC Perl</h2>
				<p>
					Open a terminal and go to the directory where you have uncompressed the PCSC Perl module archive. Enter the commands :
				</p>
				<p>
					<code>
						cd ../pcsc-perl-1.4.13/<br/>
						export PKG_CONFIG_PATH=/opt/pcsc/lib/pkgconfig/<br>
						perl Makefile.PL<br>
						make<br>
						make install
					</code>
				</p>

				<h2>Installing PCSC Tools</h2>
				<p>
					Open a terminal and go to the directory where you have uncompressed the PCSC Tools utilities archive. Enter the commands :
				</p>
				<p>
					<code>
						cd ../pcsc-tools-1.4.23/<br/>
						export PKG_CONFIG_PATH=/opt/pcsc/lib/pkgconfig/<br>
						make<br>
						make install
					</code>
				</p>

				<h2>Change Info.plist</h2>
				<p>
					With some old Linux distributions, the file called info.plist is not up to date so you may have to change it to work with our readers.
				</p>
				<p>
					Locate the file called Info.plist, for example with a command like this one :
				</p>
				<p>
					<code>sudo find / -name Info.plist</code>
				</p>
				<p>
					You will, for example, find it in&nbsp;/usr/local/lib/pcsc/drivers/ifd-ccid.bundle/Contents/Info.plist
				</p>
				<p>
					Edit the file to add your product’s IDs.
				</p>
				<p>
					<a title="Open CCID driver’s Info.plist" href="http://tech.springcard.com/guides/pcsc-unix-with-pcsclite/#plist">You can refer to the section dedicated to Mac Os X to see what you need to change.</a>
				</p>

				<h2>Installing PCSC over Network Driver</h2>
				<p>
					Open a terminal and go to the directory where you have uncompressed the PCSC over Network Driver archive and copy all files inf the ccid-x-y-z/src/ directory. Enter the commands :
				</p>
				<p>
					<code>
						cd ..<br />
						cp springcard_ccid_tcp/* ../ccid-x-y-z/src/<br/>
						cmmod a+x build.sh<br />
						./build.sh
						mkdir /opt/pcsc/etc/
						mkdir /opt/pcsc/etc/reader.conf.d/
					</code>
				</p>
				<br/>
				<img src="img/sprpcsc2.png">

				<h2>Create configuration files</h2>
				<p>
					You must create one configuration file per FunkyGate-IP-PCSC.<br/>
					Those files must be saved in the reader configuration directory /opt/pcsc/etc/reader.conf.d/.<br /><br/>
					Each configuration must have those parameters :
					<ul>
						<li>FRIENDLYNAME : a (near)human readable string describing the reader</li>
						<li>DEVICENAME : a colon-separated string containing network informations about your reader (IP:PORT:OPTION BYTE:KEY) :<br/>
							<ul>
								<li>IP : your device IP address</li>
								<li>PORT : tcp port used to contact the reader</li>
								<li>OPTION BYTE : communication options (device dependant), default is <strong>00</strong></li>
								<li>KEY : depending on OPTION BYTE, default is <strong>nokey</strong></li>
							</ul>
						</li>
						<li>LIBPATH : full path to the PCSC over Network Driver library file</li>
					</ul>
				</p>
				<br/>
				<img src="img/sprpcsc3.png">

				<h2>Enabling PCSC-Lite daemon</h2>
				<p>
					PCSC-Lite’s pcscd process must be running in the background.
				</p>
				<p>
					PCSC-Lite’s pcscd process must be running under an elevated user (root for example).
				</p>
				<p>
					If you have some problems with the daemon you can launch it this way to see some error messages :&nbsp;<em>pcscd -fd</em>
				</p>
				<img src="img/sprpcsc4.png">
				<p>
					If you see some error messages related to “permission denied”, try to launch&nbsp;<em>make fix-rights</em> from the folder where you have downloaded pcsc-lite (use sudo if necessary).
				</p>
				
				<h2>Starting pcscd manually</h2>
				<p>
					Open a terminal and go to the directory where PCSC-Lite has been installed. Typically, this is <code>/usr/local/sbin/pcscd</code>.
				</p>
				<p>
					In this directory, enter the command <code>./pcscd</code>.
				</p>
				
				<h2>Configuring pcscd to be launched on startup</h2>
				<p>
					It is better to have <code>pcscd</code> automatically started when the computer starts. To do so, you must add <code>pcscd</code> in the list of processes started in <code>rc.local</code> or equivalent startup script.
				</p>

				<h2>Connecting the device</h2>
				<p>
					Plug your "configured" reader onto the network.
				</p>
				<p>
					In a terminal, use the command <code>pcsc_scan</code> to verify that your device is present :
				</p>
				<img src="img/sprpcsc5.png">

				<p>
					<em>In the above screenshot, we have two <a title="FunkyGate-IP-PCSC" href="http://www.springcard.com/en/products/csb6.FunkyGate-IP-PCSC" target="_blank">FunkyGate-IP-PCSC</a> connected.
				</p>

				<h2>Validating the installation</h2>
				<p>
					To test the newly installed reader, we could <strong>pcsc_scan</strong>, just bring a card on the reader and you should view activity on you terminal :
				</p>
				<img src="img/sprpcsc6.png">
				<p>
					We can also use <code>gscriptor</code> (the graphical version of included <code>scriptor</code>) for validation.
				</p>
				<img src="img/sprpcsc7.png">

				<h2>Card connect</h2>
				<p>
					Select the contactless slot of your reader,<br/>
					<font color='red'><strong>Put any compliant contactless card on the reader</strong></font>,<br/>
					Connect to the card (Reader -&gt; Connect).<br/>
				</p>
				<img src="img/sprpcsc8.png">

				<h2>APDU exchange</h2>
				<p>
					Write the APDU command in the script panel. You may use the command <code>FF CA 00 00 00</code> (get card serial number) as a test.
				</p>
				<p>
					Click Run. Observe card’s response in the result panel.
				</p>
				<p>
					<em>Well, in this test this not actually a response from the card… The command FFCA000000 is interpreted by the reader (CLA=FF is reserved for the embedded APDU interpreter), so it is the reader that actually answers. The returned data are the serial number of the contactless card. Remember, we’ve put ‘any’ contactless card on the reader, and querying the serial number is more or less the only command that is available for any kind of card…</em>
				</p>
				
				<h2>Troubleshooting</h2>
				<p>
					If invoking gscriptor fails with message <code>Can't locate Chipcard/PCSC.pm</code>, re-install PCSC-Perl and/or verify PERL’s include directories.
				</p>
			</div>
		</article>
	</div>
</body>
</html>